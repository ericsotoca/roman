<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur d'Histoires Interactif</title>
    <style>
        :root {
            --background-color: #e0f2f7; /* Bleu très clair */
            --card-background: #ffffff;
            --card-border: #b0bec5;
            --card-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            --button-bg: #0277bd; /* Bleu */
            --button-hover-bg: #01579b;
            --button-text: #ffffff;
            --stop-button-bg: #d32f2f; /* Rouge */
            --stop-button-hover-bg: #b71c1c;
            --active-card-border: #0277bd; /* Bleu pour indiquer l'activité */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: #333;
        }

        h1 {
            text-align: center;
            color: #01579b; /* Bleu foncé */
            margin-bottom: 30px;
        }

        #stories-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid */
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto; /* Center the container */
        }

        .story-card {
            background-color: var(--card-background);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .story-card.active {
            border-color: var(--active-card-border);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .story-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            flex-grow: 1; /* Pousse les boutons en bas si titres courts */
             color: #01579b;
        }

        .story-controls {
            display: flex;
            gap: 10px;
            margin-top: auto; /* Aligne les boutons en bas */
        }

        .story-controls button {
            padding: 8px 15px;
            font-size: 0.9em;
            border: none;
            border-radius: 5px;
            color: var(--button-text);
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-grow: 1; /* Fait que les boutons prennent la largeur dispo */
        }

        .story-controls .play-pause-button {
            background-color: var(--button-bg);
        }
        .story-controls .play-pause-button:hover {
            background-color: var(--button-hover-bg);
        }
        .story-controls .play-pause-button:disabled {
             background-color: #90a4ae; /* Gris quand désactivé */
             cursor: not-allowed;
        }


        .story-controls .stop-button {
            background-color: var(--stop-button-bg);
            flex-grow: 0; /* Ne grandit pas autant que le play/pause */
            min-width: 60px; /* Largeur minimale pour "Stop" */
        }
        .story-controls .stop-button:hover {
            background-color: var(--stop-button-hover-bg);
        }
         .story-controls .stop-button:disabled {
             background-color: #cfcfcf;
             cursor: not-allowed;
        }

        /* Style pour l'état "Pause" */
        .story-controls .play-pause-button.paused {
            background-color: #ffa000; /* Orange pour indiquer la pause */
        }
        .story-controls .play-pause-button.paused:hover {
            background-color: #ef6c00;
        }

    </style>
</head>
<body>
    <h1>Lecteur d'Histoires Interactif</h1>
    <div id="stories-container">
        <!-- Les histoires seront chargées ici par JavaScript -->
    </div>

    <script>
        const storiesContainer = document.getElementById('stories-container');
        let currentUtterance = null;
        let activeStoryCard = null; // Garde une référence à la carte active
        let voices = []; // Pour stocker les voix disponibles

        // Pré-charger les voix (important car elles peuvent ne pas être prêtes immédiatement)
        function populateVoiceList() {
            voices = speechSynthesis.getVoices().filter(voice => voice.lang === 'fr-FR' || voice.lang.startsWith('fr-'));
            // Si vous voulez une voix spécifique (par exemple, la première française trouvée)
             // console.log("Voix françaises disponibles:", voices);
        }

        populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        // Fonction pour charger et afficher les histoires
        async function loadStories() {
            const storyFiles = [
                'histoire1.txt', 'histoire2.txt', 'histoire3.txt',
                'histoire4.txt', 'histoire5.txt', 'histoire6.txt',
                'histoire7.txt', 'histoire8.txt', 'histoire9.txt'
            ];

            for (const filename of storyFiles) {
                try {
                    const response = await fetch(`stories/${filename}`);
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    const text = await response.text();
                    const title = text.split('\n')[0] || filename; // Utilise nom fichier si titre vide

                    createStoryCard(title, text);

                } catch (error) {
                    console.error(`Impossible de charger l'histoire ${filename}:`, error);
                    // Optionnel: Afficher une carte d'erreur à l'utilisateur
                     createErrorCard(filename);
                }
            }
        }

         // Fonction pour créer une carte d'histoire
        function createStoryCard(title, text) {
            const card = document.createElement('div');
            card.className = 'story-card';

            const titleElement = document.createElement('div');
            titleElement.className = 'story-title';
            titleElement.textContent = title;

            const controls = document.createElement('div');
            controls.className = 'story-controls';

            const playPauseButton = document.createElement('button');
            playPauseButton.textContent = 'Lire';
            playPauseButton.className = 'play-pause-button';
            playPauseButton.onclick = () => handlePlayPause(card, text, playPauseButton, stopButton);

            const stopButton = document.createElement('button');
            stopButton.textContent = 'Stop';
            stopButton.className = 'stop-button';
            stopButton.disabled = true; // Désactivé au début
            stopButton.onclick = () => handleStop(card, playPauseButton, stopButton);

            controls.appendChild(playPauseButton);
            controls.appendChild(stopButton);

            card.appendChild(titleElement);
            card.appendChild(controls);

            storiesContainer.appendChild(card);
        }

         // Fonction pour créer une carte d'erreur
        function createErrorCard(filename) {
             const card = document.createElement('div');
            card.className = 'story-card error-card'; // Vous pouvez ajouter un style CSS pour .error-card
            card.style.borderColor = 'red'; // Style simple pour l'erreur
            card.innerHTML = `<div class="story-title">Erreur</div><div>Impossible de charger ${filename}</div>`;
            storiesContainer.appendChild(card);
        }


        // Gère le clic sur le bouton Lire/Pause/Reprendre
        function handlePlayPause(card, text, playPauseButton, stopButton) {
            // Si on clique sur "Lire" pour une nouvelle histoire alors qu'une autre est en cours/pause
            if (activeStoryCard && activeStoryCard !== card && currentUtterance) {
                 handleStop(activeStoryCard,
                           activeStoryCard.querySelector('.play-pause-button'),
                           activeStoryCard.querySelector('.stop-button')); // Arrête l'ancienne histoire d'abord
            }

            if (!currentUtterance) {
                // --- Démarrer la lecture ---
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.lang = 'fr-FR';

                // Sélectionner une voix française si disponible
                 if (voices.length > 0) {
                    // Essayez de trouver une voix spécifique ou prenez la première
                     currentUtterance.voice = voices[0]; // Ou une logique plus fine pour choisir
                     // console.log("Utilisation de la voix:", currentUtterance.voice.name);
                 } else {
                     console.warn("Aucune voix française trouvée. Utilisation de la voix par défaut.");
                 }


                currentUtterance.onstart = () => {
                    // console.log("Lecture démarrée");
                    updateUI(card, 'playing', playPauseButton, stopButton);
                };

                currentUtterance.onpause = () => {
                     // console.log("Lecture en pause");
                    updateUI(card, 'paused', playPauseButton, stopButton);
                };

                currentUtterance.onresume = () => {
                     // console.log("Lecture reprise");
                    updateUI(card, 'playing', playPauseButton, stopButton);
                };

                currentUtterance.onend = () => {
                     // console.log("Lecture terminée");
                    handleStop(card, playPauseButton, stopButton); // Nettoie comme un arrêt manuel
                };

                currentUtterance.onerror = (event) => {
                    console.error("Erreur de Synthèse Vocale:", event.error);
                    handleStop(card, playPauseButton, stopButton); // Nettoie en cas d'erreur
                };

                activeStoryCard = card; // Marque cette carte comme active
                speechSynthesis.speak(currentUtterance);

            } else if (speechSynthesis.paused) {
                // --- Reprendre la lecture ---
                speechSynthesis.resume();
            } else {
                // --- Mettre en pause la lecture ---
                speechSynthesis.pause();
            }
        }

        // Gère le clic sur le bouton Stop
        function handleStop(card, playPauseButton, stopButton) {
            if (speechSynthesis.speaking || speechSynthesis.paused) {
                speechSynthesis.cancel(); // Arrête immédiatement
            }
            currentUtterance = null;
            activeStoryCard = null;
             // Réinitialise l'UI de la carte qui vient d'être arrêtée
            updateUI(card, 'stopped', playPauseButton, stopButton);

            // S'assure que toutes les autres cartes sont aussi dans l'état 'stopped' (au cas où)
             resetAllOtherCardsUI(card);
        }

        // Met à jour l'interface utilisateur d'une carte spécifique
        function updateUI(card, state, playPauseButton, stopButton) {
             // Gère la classe 'active' sur la carte
             document.querySelectorAll('.story-card').forEach(c => c.classList.remove('active'));
             if (state === 'playing' || state === 'paused') {
                 card.classList.add('active');
             } else {
                 card.classList.remove('active');
             }

            // Gère les boutons
             playPauseButton.classList.remove('paused'); // Enlève le style pause par défaut

            switch (state) {
                case 'playing':
                    playPauseButton.textContent = 'Pause';
                    playPauseButton.disabled = false;
                    stopButton.disabled = false;
                     resetAllOtherCardsUI(card); // Réinitialise les autres cartes
                    break;
                case 'paused':
                    playPauseButton.textContent = 'Reprendre';
                    playPauseButton.classList.add('paused'); // Ajoute le style pause
                    playPauseButton.disabled = false;
                    stopButton.disabled = false;
                    break;
                case 'stopped':
                default:
                    playPauseButton.textContent = 'Lire';
                    playPauseButton.disabled = false;
                    stopButton.disabled = true;
                    card.classList.remove('active'); // Assure qu'elle n'est plus active visuellement
                    break;
            }
        }

         // Réinitialise l'UI de toutes les cartes SAUF celle spécifiée
        function resetAllOtherCardsUI(currentCard) {
            const allCards = document.querySelectorAll('.story-card');
            allCards.forEach(card => {
                if (card !== currentCard) {
                    const ppButton = card.querySelector('.play-pause-button');
                    const sButton = card.querySelector('.stop-button');
                    if (ppButton && sButton) {
                         ppButton.textContent = 'Lire';
                         ppButton.disabled = false;
                         ppButton.classList.remove('paused');
                         sButton.disabled = true;
                         card.classList.remove('active');
                    }
                }
            });
        }


        // Charger les histoires au démarrage
        loadStories();

    </script>
</body>
</html>
