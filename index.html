<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur d'Histoires</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2, #80deea);
            min-height: 100vh;
            color: #333;
        }

        .container {
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #0277bd;
            margin-bottom: 30px;
            font-size: 2.2rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        #stories {
            margin-top: 20px;
            width: 100%;
        }
        
        .story {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        
        .story:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .story-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #cccccc;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .status-active {
            background-color: #4caf50;
            box-shadow: 0 0 5px #4caf50;
            animation: pulse 1.5s infinite;
        }
        
        .story-title {
            font-weight: bold;
            font-size: 1.1rem;
            flex-grow: 1;
        }
        
        .story-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: background-color 0.2s;
            color: white;
            flex: 1;
            min-width: 90px;
        }
        
        .btn-play {
            background-color: #4caf50;
        }
        
        .btn-play:hover {
            background-color: #3e8e41;
        }
        
        .btn-pause {
            background-color: #ff9800;
        }
        
        .btn-pause:hover {
            background-color: #e68a00;
        }
        
        .btn-stop {
            background-color: #f44336;
        }
        
        .btn-stop:hover {
            background-color: #d32f2f;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.9rem;
            color: #555;
            padding: 0 20px;
        }
        
        /* Styles spécifiques pour mobile */
        @media (max-width: 600px) {
            .story-controls {
                justify-content: center;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 16px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.2);
            border-radius: 50%;
            border-top-color: #0277bd;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            text-align: center;
            margin: 20px 0;
        }
        
        .error-message {
            color: #f44336;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }

        .compatibility-message {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 0 4px 4px 0;
            display: none;
        }
    </style>

</head>
<body>
    <div class="container">
        <h1><i class="fas fa-book-open"></i> Lecteur d'Histoires</h1>
        <div id="compatibility-warning" class="compatibility-message">
            <i class="fas fa-exclamation-triangle"></i> 
            Sur certains appareils mobiles, la synthèse vocale peut nécessiter des permissions ou ne pas fonctionner correctement.
        </div>
        <div id="stories">
            <div class="loading-text">
                <div class="loader"></div> Chargement des histoires...
            </div>
        </div>
    </div>
    <div class="footer">
        Lecteur d'histoires - Profitez d'une lecture à haute voix
    </div>

<script>
    const storiesContainer = document.getElementById('stories');
    const compatibilityWarning = document.getElementById('compatibility-warning');
    let currentlyPlaying = null;
    const isMobile = /iPhone|iPad|iPod|Android/.test(navigator.userAgent);

    // Vérification de la compatibilité
    function checkCompatibility() {
        if (!('speechSynthesis' in window) || !('SpeechSynthesisUtterance' in window)) {
            compatibilityWarning.style.display = 'block';
            compatibilityWarning.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Votre navigateur ne prend pas en charge la synthèse vocale.';
            return false;
        }
        
        if (isMobile) {
            compatibilityWarning.style.display = 'block';
        }
        
        return true;
    }

    // Fonction pour charger les histoires
    async function loadStories() {
        const stories = [
            'histoire1.txt', 'histoire2.txt', 'histoire3.txt',
            'histoire4.txt', 'histoire5.txt', 'histoire6.txt',
            'histoire7.txt', 'histoire8.txt', 'histoire9.txt'
        ];
        
        // Vérifier la compatibilité
        checkCompatibility();
        
        // Effacer le message de chargement
        storiesContainer.innerHTML = '';
        
        let loadedStories = 0;
        let errorOccurred = false;

        for (let i = 0; i < stories.length; i++) {
            const story = stories[i];
            try {
                // Essayer de charger le fichier texte
                // Ajout d'un paramètre cache-buster pour éviter les problèmes de cache
                const response = await fetch(`stories/${story}?v=${new Date().getTime()}`);
                
                if (!response.ok) {
                    throw new Error(`Erreur lors du chargement de ${story}: ${response.status}`);
                }
                
                const text = await response.text();
                
                // Extraire le titre de la première ligne
                const title = text.split('\n')[0].trim() || `Histoire ${i+1}`;
                
                createStoryElement(story, title, text);
                loadedStories++;
            } catch (error) {
                console.error(error);
                errorOccurred = true;
                
                // En cas d'erreur, utiliser un titre par défaut et un contenu d'exemple
                createStoryElement(
                    story, 
                    `Histoire ${i+1}`, 
                    `Histoire ${i+1}\n\nCeci est un exemple de contenu pour l'histoire ${i+1}. Veuillez vérifier que les fichiers texte sont bien présents dans le dossier "stories".`
                );
            }
        }
        
        // Afficher un message si des erreurs se sont produites
        if (errorOccurred) {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'error-message';
            errorMessage.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> 
                Certains fichiers d'histoires n'ont pas pu être chargés. 
                Veuillez vérifier que les fichiers existent dans le dossier "stories".
            `;
            storiesContainer.appendChild(errorMessage);
        }
    }

    // Fonction pour créer l'élément d'une histoire
    function createStoryElement(id, title, text) {
        const storyElement = document.createElement('div');
        storyElement.className = 'story';
        storyElement.dataset.id = id;
        
        // Créer l'en-tête de l'histoire avec indicateur et titre
        const storyHeader = document.createElement('div');
        storyHeader.className = 'story-header';
        
        const statusIndicator = document.createElement('div');
        statusIndicator.className = 'status-indicator';
        
        const titleElement = document.createElement('div');
        titleElement.className = 'story-title';
        titleElement.textContent = title;
        
        storyHeader.appendChild(statusIndicator);
        storyHeader.appendChild(titleElement);
        
        // Créer la zone des contrôles
        const controlsElement = document.createElement('div');
        controlsElement.className = 'story-controls';
        
        // Bouton Play
        const playButton = document.createElement('button');
        playButton.className = 'btn btn-play';
        playButton.innerHTML = '<i class="fas fa-play"></i> Lire';
        playButton.addEventListener('click', () => readStory(id, text, statusIndicator, playButton, pauseButton, stopButton));
        
        // Bouton Pause
        const pauseButton = document.createElement('button');
        pauseButton.className = 'btn btn-pause';
        pauseButton.innerHTML = '<i class="fas fa-pause"></i> Pause';
        pauseButton.disabled = true;
        pauseButton.addEventListener('click', () => pauseStory(id));
        
        // Bouton Stop
        const stopButton = document.createElement('button');
        stopButton.className = 'btn btn-stop';
        stopButton.innerHTML = '<i class="fas fa-stop"></i> Stop';
        stopButton.disabled = true;
        stopButton.addEventListener('click', () => stopStory(id));
        
        controlsElement.appendChild(playButton);
        controlsElement.appendChild(pauseButton);
        controlsElement.appendChild(stopButton);
        
        storyElement.appendChild(storyHeader);
        storyElement.appendChild(controlsElement);
        
        storiesContainer.appendChild(storyElement);
    }

    // Gérer l'état des synthèses vocales
    const speechSynthesisMap = {};

    // Fonction pour lire une histoire à haute voix
    function readStory(id, text, statusIndicator, playButton, pauseButton, stopButton) {
        // Arrêter l'histoire en cours s'il y en a une
        if (currentlyPlaying && currentlyPlaying !== id) {
            const currentId = currentlyPlaying;
            stopStory(currentId);
        }
        
        // Si c'est déjà cette histoire qui joue, ne rien faire
        if (currentlyPlaying === id) return;
        
        // Vérification de la prise en charge
        if (!('speechSynthesis' in window) || !('SpeechSynthesisUtterance' in window)) {
            alert("Votre navigateur ne prend pas en charge la synthèse vocale.");
            return;
        }

        // Approche différente pour mobile et desktop
        if (!isMobile) {
            // Code normal pour PC
            // Créer une nouvelle instance de SpeechSynthesisUtterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';

            // Forcer l'initialisation des voix
            let voices = window.speechSynthesis.getVoices();
            
            // Pour Chrome, on doit attendre que les voix soient chargées
            if (voices.length === 0) {
                window.speechSynthesis.onvoiceschanged = function() {
                    voices = window.speechSynthesis.getVoices();
                    setFrenchVoice(utterance, voices);
                    startSpeaking(utterance);
                };
            } else {
                setFrenchVoice(utterance, voices);
                startSpeaking(utterance);
            }
            
            function setFrenchVoice(utterance, voices) {
                // Essayer d'abord une voix française
                const frenchVoice = voices.find(voice => voice.lang.includes('fr'));
                if (frenchVoice) {
                    utterance.voice = frenchVoice;
                }
                
                // Si pas de voix française, prendre la première disponible
                if (!utterance.voice && voices.length > 0) {
                    utterance.voice = voices[0];
                }
                
                utterance.volume = 1; // Max volume
            }
            
            function startSpeaking(utterance) {
                // Stocker l'instance de la synthèse vocale
                speechSynthesisMap[id] = {
                    utterance: utterance,
                    statusIndicator: statusIndicator,
                    playButton: playButton,
                    pauseButton: pauseButton,
                    stopButton: stopButton,
                    isPaused: false
                };
                
                // Démarrer la lecture
                try {
                    window.speechSynthesis.cancel(); // Arrêter toute synthèse en cours
                    window.speechSynthesis.speak(utterance);
                    
                    // Mettre à jour l'interface
                    statusIndicator.classList.add('status-active');
                    playButton.disabled = true;
                    pauseButton.disabled = false;
                    stopButton.disabled = false;
                    
                    // Gérer la fin de la lecture
                    utterance.onend = () => {
                        resetStoryState(id);
                    };
                    
                    // Définir l'histoire en cours de lecture
                    currentlyPlaying = id;
                } catch (error) {
                    console.error("Erreur lors de la lecture:", error);
                    alert("Impossible de lire l'histoire. Veuillez vérifier que votre appareil prend en charge la synthèse vocale.");
                    resetStoryState(id);
                }
            }
        } else {
            // Code spécifique pour mobile
            try {
                // Approche simplifiée pour mobile
                window.speechSynthesis.cancel(); // Arrêter toute synthèse en cours
                
                const mobileUtterance = new SpeechSynthesisUtterance();
                
                // Sur mobile, le texte long peut causer des problèmes
                // Diviser le texte en paragraphes plus courts si nécessaire
                const paragraphs = text.split('\n\n');
                let currentParagraph = 0;
                
                // Fonction pour parler le paragraphe actuel
                function speakCurrentParagraph() {
                    if (currentParagraph < paragraphs.length) {
                        const currentText = paragraphs[currentParagraph];
                        mobileUtterance.text = currentText;
                        mobileUtterance.lang = 'fr-FR';
                        
                        // Essayer de définir une voix française si disponible
                        const voices = window.speechSynthesis.getVoices();
                        const frenchVoice = voices.find(voice => voice.lang.includes('fr'));
                        if (frenchVoice) {
                            mobileUtterance.voice = frenchVoice;
                        }
                        
                        // Parler le paragraphe actuel
                        window.speechSynthesis.speak(mobileUtterance);
                        
                        // Avancer au paragraphe suivant quand celui-ci est terminé
                        mobileUtterance.onend = function() {
                            currentParagraph++;
                            if (currentParagraph < paragraphs.length && currentlyPlaying === id) {
                                // Continuer si on n'a pas arrêté la lecture
                                speakCurrentParagraph();
                            } else {
                                // Fin de l'histoire
                                resetStoryState(id);
                            }
                        };
                    }
                }
                
                // Commencer la lecture
                speakCurrentParagraph();
                
                // Mettre à jour l'interface
                statusIndicator.classList.add('status-active');
                playButton.disabled = true;
                pauseButton.disabled = false;
                stopButton.disabled = false;
                
                // Définir l'histoire en cours
                currentlyPlaying = id;
                
                // Stocker les références
                speechSynthesisMap[id] = {
                    utterance: mobileUtterance,
                    statusIndicator: statusIndicator,
                    playButton: playButton,
                    pauseButton: pauseButton,
                    stopButton: stopButton,
                    isPaused: false,
                    currentParagraph: currentParagraph,
                    paragraphs: paragraphs,
                    speakFunction: speakCurrentParagraph
                };
                
                // Sur iOS, forcer la synthèse à démarrer
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    setTimeout(() => {
                        window.speechSynthesis.pause();
                        window.speechSynthesis.resume();
                    }, 100);
                }
            } catch (error) {
                console.error("Erreur mobile:", error);
                alert("Impossible de lire l'histoire sur votre appareil mobile. Veuillez vérifier que votre appareil prend en charge la synthèse vocale.");
                resetStoryState(id);
            }
        }
    }

    // Fonction pour mettre en pause une histoire
    function pauseStory(id) {
        const storyData = speechSynthesisMap[id];
        
        if (storyData && !storyData.isPaused) {
            window.speechSynthesis.pause();
            storyData.isPaused = true;
            storyData.pauseButton.innerHTML = '<i class="fas fa-play"></i> Reprendre';
            storyData.statusIndicator.style.animationPlayState = 'paused';
        } else if (storyData && storyData.isPaused) {
            window.speechSynthesis.resume();
            storyData.isPaused = false;
            storyData.pauseButton.innerHTML = '<i class="fas fa-pause"></i> Pause';
            storyData.statusIndicator.style.animationPlayState = 'running';
            
            // Sur iOS, forcer la reprise
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                setTimeout(() => {
                    window.speechSynthesis.pause();
                    window.speechSynthesis.resume();
                }, 100);
            }
        }
    }

    // Fonction pour arrêter la lecture
    function stopStory(id) {
        window.speechSynthesis.cancel();
        resetStoryState(id);
        currentlyPlaying = null;
    }

    // Fonction pour réinitialiser l'état de l'interface d'une histoire
    function resetStoryState(id) {
        const storyData = speechSynthesisMap[id];
        
        if (storyData) {
            storyData.statusIndicator.classList.remove('status-active');
            storyData.statusIndicator.style.animationPlayState = '';
            storyData.playButton.disabled = false;
            storyData.pauseButton.disabled = true;
            storyData.pauseButton.innerHTML = '<i class="fas fa-pause"></i> Pause';
            storyData.stopButton.disabled = true;
            
            // Supprimer les données de cette histoire
            delete speechSynthesisMap[id];
        }
    }

    // Setup pour tous les appareils
    function setupAudio() {
        if (isMobile) {
            document.body.addEventListener('click', function() {
                setTimeout(() => {
                    try {
                        // Initialiser la synthèse vocale avec un texte vide
                        const silence = new SpeechSynthesisUtterance('');
                        silence.volume = 0;
                        window.speechSynthesis.speak(silence);
                        
                        // Sur iOS, il faut aussi parfois faire pause/resume
                        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                            setTimeout(() => {
                                window.speechSynthesis.pause();
                                window.speechSynthesis.resume();
                            }, 100);
                        }
                    } catch (e) {
                        console.error("Erreur lors de l'initialisation audio:", e);
                    }
                }, 500);
            }, { once: true });
        }
    }

    // Vérifier régulièrement si la synthèse s'est arrêtée de manière inattendue
    function setupWatchdog() {
        if (isMobile) {
            setInterval(() => {
                if (currentlyPlaying) {
                    const storyData = speechSynthesisMap[currentlyPlaying];
                    if (storyData && !storyData.isPaused && !window.speechSynthesis.speaking) {
                        // La synthèse s'est arrêtée sans qu'on le demande, essayer de la relancer
                        console.log("Watchdog: détection d'un arrêt inattendu de la synthèse vocale");
                        window.speechSynthesis.resume();
                    }
                }
            }, 1000);
        }
    }

    // Initialiser au chargement
    document.addEventListener('DOMContentLoaded', () => {
        loadStories();
        setupAudio();
        setupWatchdog();
    });
</script>
</body>
</html>
